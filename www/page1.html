<style>
</style>

<ons-navigator title="Navigator" var="homeNavigator">
    <ons-page>
        <ons-toolbar fixed-style>
            <div class="left" style="line-height: 44px">
                <img src="images/logo.png" style="height:32px; margin-left:10px;" onClick="gotoPage1()"/>
            </div>
            <div class="center">
                <img src="images/go2gether.png" style="height:32px;"/>
            </div>
            <div class="right" style="line-height: 44px">
                <ons-toolbar-button ng-click="menu.toggleMenu()">
                	<ons-icon icon="ion-navicon" style="font-size: 32px; width: 1em;"></ons-icon>
        		</ons-toolbar-button>
            </div>
        </ons-toolbar>

        <div id="map"></div>

    </ons-page>
    
    <ons-template id="alert-dialog.html">
        <ons-alert-dialog var="alertDialog">
            <div class="alert-dialog-title">
                <strong style="color: #ff3333" id="alertDialogTitle">定位失敗!</strong>    
            </div>
            <div class="alert-dialog-content">
                <span id="alertDialogText">請確定已開啟GPS功能，並重新嘗試</span>
            </div>
            <div class="alert-dialog-footer">
                <button class="alert-dialog-button" onClick="location.reload()">OK</button>
            </div>
        </ons-alert-dialog>
    </ons-template>

</ons-navigator>

<script>

ons.ready(function() {
    setTimeout(function() {
            
        menu.setSwipeable(false);
    }, 10);
});

$(function(){

    isFirstTime = true;

    var options = {
      enableHighAccuracy: true,     // 高精度定位
	  timeout: 10000,               // 10秒 timeout
	  maximumAge: 3 * 60 * 1000     // 暫存3分鐘
	};
	
	function success(pos) {
	  
        //var crd = pos.coords;
	    //console.log('Your current position is:');
	    //console.log('Latitude : ' + crd.latitude);
	    //console.log('Longitude: ' + crd.longitude);
	    //console.log('More or less ' + crd.accuracy + ' meters.');

	    init(pos);
        HoldOn.close();
	};
	
	function error(err) {
	    /*
        console.warn('ERROR(' + err.code + '): ' + err.message);
        ons.createAlertDialog('alert-dialog.html').then(function(alertDialog) {
            alertDialog.show();
        });*/          
	};

	navigator.geolocation.getCurrentPosition(success, error, options);
});
	

function init(position) {
    
	var infowindow = new google.maps.InfoWindow({
		content: ""
	});

	// Init map
	var map = new google.maps.Map($('#map').get(0), {
		center: {lat: position.coords.latitude, lng: position.coords.longitude},
		zoom: 19,
		mapTypeControl: false,
		streetViewControl: false,
	});

    /*
	var marker = new google.maps.Marker({
		position: {lat: position.coords.latitude, lng: position.coords.longitude},
		map: map
	});
    */

	var markers = {};
	map.addListener('bounds_changed', function(){

		var bounds = map.getBounds();
		var center = map.getCenter();
		//console.log("lat("+center.lat()+") lng("+center.lng()+")");
        window.localStorage.setItem("center", center.lat()+","+center.lng());

		var corner = bounds.getNorthEast();
		var radius = GeoFire.distance([center.lat(), center.lng()], [corner.lat(), corner.lng()]);

        if(isFirstTime == true) {
    	
            isFirstTime = false;

			geoQuery.on('key_entered', function(key, location, distance) {

                var location = new google.maps.LatLng(location[0], location[1]);
                //console.log("lat("+location.lat()+") lng("+location.lng()+")");

                areas.child(key).child("appointment").once('value', function(snapshot) {
                    
                    //console.log("lat("+location.lat()+") lng("+location.lng()+")");

                    var appointment = snapshot.val();
                    //console.log("appointment("+appointment+")");
                    var d = new Date();
            		var current_time = d.getTime();
                    var diff = appointment - current_time;
                    //console.log("diff("+diff+") appointment("+appointment+") current_time("+current_time+")");
                    
                    var image;
                    var minutesDifference = Math.floor(diff/1000/60);
                    //console.log("minutesDifference("+minutesDifference+")"); 
    				if(minutesDifference <= 10)         image = "images/marker_red.png";
                    else if(minutesDifference <= 60)    image = "images/marker_yellow.png";
                    else                                image = "images/marker_green.png";

    				markers[key] = new google.maps.Marker({
    					position: location,
    					map: map,
    					icon: image
    				});

                    markers[key].addListener('click', function() {

        				areas.child(key).once('value', function(snapshot) {

    						//console.log(snapshot.val());
    						var destination = snapshot.val().destination;	// 目的地
    						var timestamp = snapshot.val().appointment;		// 共乘時間
    						var purpose = snapshot.val().purpose;			// 共乘目的
    						var d = new Date(timestamp);
    						var time_text = d.toLocaleString();
    
    						var text = "";
                            text += "<div>目的地："+destination+"</div>";
    						text += "<div>共乘時間："+time_text+"</div>";
    						text += "<div>共乘目的："+purpose+"</div>";
    
                            window.localStorage.setItem("info_key", key);
    
    						infowindow.setContent("<div onClick='openInfo()' style='width:200px;min-height:40px'>"+text+"</div>");
    						infowindow.open(map, markers[key]);
    
    						//map.setZoom(19);
    						map.panTo(location);
    
                            ga('send', 'event', '首頁', 'click', "圖標");
    					});
    				});
                });
			});

			//remove marker, un-highlight
			geoQuery.on('key_exited', function(key, location, distance) {

				markers[key].setMap(null);
				delete markers[key];
			});
		}

        if(isFirstTime == false) {

			geoQuery.updateCriteria({
				center: [ center.lat(), center.lng() ],
				radius: radius,
		    });
        }
	});
}

function openInfo() {

    ga('send', 'event', '首頁', 'click', '共乘泡泡');
    homeNavigator.pushPage("page1_info.html", {animation: 'slide'});
}

</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-84401162-1', 'auto');
  ga('send', 'pageview', '首頁');
</script>