<style>
.slider_img {
    margin: 0 auto;
    height:100%;
}

.myCarousel {
    text-align: center;
}

.mySection {
    padding: 16px; 
    border: rgba(0,0,0,0.2) 1px solid;
    -webkit-border-radius: 5px;
    -moz-border-radius: 5px;
    border-radius: 5px;
}

.text1 {
    color:#aaa8a8;
    width:20%;
    display: inline-flex;
}
.text2 {
    color:#686d6d;
    width: 80%;
    display: inline-flex;
}
</style>

<ons-navigator title="Navigator" var="page6Navigator">
    <ons-page style="background:#fff;">
    
        <ons-toolbar>
            <div class="left" style="line-height: 44px">
                <img src="images/logo.png" style="height:18px; margin-left:10px;"/>
            </div>
            <div class="center">
                <img src="images/go2gether.png" style="height:32px;"/>
            </div>
            <div class="right" style="line-height: 44px">
                <ons-toolbar-button ng-click="menu.toggleMenu()">
                    <ons-icon icon="ion-navicon" style="font-size: 32px; width: 1em;"></ons-icon>
        		</ons-toolbar-button>
            </div>
        </ons-toolbar>

        <section style="padding: 0px 16px 0 16px" class="radio_box">
            <h3>共乘記錄</h3>
        </section>
        
        <div style="clear:both; height:10px"></div>

        <div class="container">
            <ul class="nav nav-tabs">
                <li class="active" style="width:50%;"><a data-toggle="tab" href="#reserve">預約記錄</a></li>
                <li style="width:50%;"><a data-toggle="tab" href="#history">歷程記錄</a></li>
            </ul>
        
            <div class="tab-content">
                <div id="reserve" class="tab-pane fade in active"></div>
                <div id="history" class="tab-pane fade"></div>
            </div>
        </div>

        <ons-template id="alert-dialog.html">
            <ons-alert-dialog var="alertDialog">
                <div class="alert-dialog-content">
                    請先登入帳號
                </div>
                <div class="alert-dialog-footer">
                    <button class="alert-dialog-button" onClick="needLogin()">OK</button>
                </div>
            </ons-alert-dialog>
        </ons-template>

    </ons-page>
</ons-navigator>

<script>
    //window.localStorage.setItem("facebook_id", "100000151115805");
    ons.ready(function() {
        setTimeout(function() {

            // 檢查 facebook 是否已登入
            if(window.localStorage.getItem("facebook_id") == "" || window.localStorage.getItem("facebook_id") == null ) {

                ons.createAlertDialog('alert-dialog.html').then(function(alertDialog) {
                    alertDialog.show();
                });
                    
                return;
            }

            var fb_id = window.localStorage.getItem("facebook_id");
            //console.log("page6 ==> fb_id("+fb_id+")");
            //fb_id = "1389354124412945";

            // 記錄
            areas.orderByChild("fb_id").equalTo(fb_id).on("child_added", function(snapshot) {

                var key = snapshot.key;
                //console.log("key("+snapshot.key+")");

                // 時間
                var d1 = new Date(snapshot.val().timestamp);
    			var time_text = d1.toLocaleString();

                // 過期時間
                var d2 = new Date(snapshot.val().expired_time); 
                var expired_time_text = d2.toLocaleString();

                var d = new Date();
                var now_text = d.toLocaleString();

                var text = "";
                text += '<div style="clear:both; height:10px"></div>';
                
                // 預約
                if(d.getTime() < d2.getTime()) {
                    text += "<section class='mySection' onClick='showPage6Info(\""+key+"\", \"reserve\")'>";
                // 歷程
                } else {
                    text += "<section class='mySection' onClick='showPage6Info(\""+key+"\", \"history\")'>";
                }
                
                text +=     '<div><span class="text1">出發</span><span class="text2">'+snapshot.val().input_address+'</span></div>';
                text +=     '<div><span class="text1">目的</span><span class="text2">'+snapshot.val().destination+'</span></div>';
                text +=     '<div><span class="text1">時間</span><span class="text2">'+time_text+'</span></div>';
                text +=     '<div><span class="text1">備註</span><span class="text2">'+snapshot.val().note+'</span></div>';
                text += '</section>';

               
                //console.log("time_text("+time_text+") expired_time_text("+expired_time_text+") now_text("+now_text+")");
                //console.log("t1("+d.getTime()+") t2("+d2.getTime()+") diff("+(d-d2)+")");
                
                // 預約
                if(d.getTime() < d2.getTime()) {
                    $('#reserve').append(text);
                // 歷程
                } else {
                    $('#history').append(text);     
                }
            });
        }, 10);
    });
    
    function needLogin() {
        
        console.log("needLogin");
        alertDialog.hide();
        gotoPage1();
    }
    
    function showPage6Info(key, type) {

        console.log("key("+key+") type("+type+")");
        window.localStorage.setItem("page6_info_key", key);
        window.localStorage.setItem("page6_info_type", type);
        
        page6Navigator.pushPage("page6_info.html", {animation: 'slide'});
    }
    
</script>