<style>
.my_pos_img {
    -webkit-border-radius: 30px;
    -moz-border-radius: 30px;
    width: 60px;
    position: absolute;
    top: calc(50% - 60px);
    left: calc(50% - 27px);
    z-index: 1;
}

.select_pos_btn {
    background-color: #36d0c9;
    border: 0;
    font-size: 16px;
    font-weight: 500;
    line-height: 36px;
    padding: 4px 12px;
    display: block;
    width: 80%;
    text-align: center;
    color: #FFF;
    position: absolute;
    bottom: 20px;
    margin-left: 5%;
}

.search_btn {
    background-color: #36d0c9;
    border: 0;
    font-size: 16px;
    font-weight: 500;
    line-height: 36px;
    padding: 4px 12px;
    display: block;
    width: 15%;
    text-align: center;
    color: #FFF;
    position: absolute;
    margin-top: 28px;
    right: 3%;
    z-index: 99999;
    height: 40px;
    background: url(images/search.png);
    background-size: 40%;
    background-repeat: no-repeat;
    background-position: center;
    top: 0;
    right: 3%;
}

.controls {
    margin-top: 10px;
    border: 1px solid transparent;
    border-radius: 2px 0 0 2px;
    box-sizing: border-box;
    -moz-box-sizing: border-box;
    height: 32px;
    outline: none;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
}

#pac-input {
    background-color: #fff;
    font-family: Roboto;
    font-size: 15px;
    font-weight: 300;
    margin-left: 12px;
    padding: 0 11px 0 13px;
    text-overflow: ellipsis;
    width: 75%;
    margin-top: 28px;
    height: 40px;
}

#pac-input:focus {
    border-color: #4d90fe;
}

.pac-container {
    font-family: Roboto;
}

#type-selector {
    color: #fff;
    background-color: #4d90fe;
    padding: 5px 11px 0px 11px;
}

#type-selector label {
    font-family: Roboto;
    font-size: 13px;
    font-weight: 300;
}
</style>

<ons-page style="background:#fff;">

    <ons-toolbar fixed-style>
        <div class="left" style="line-height: 44px;">
            <ons-back-button></ons-back-button>
        </div>
        <div class="center">
            <img src="images/go2gether.png" style="height:32px;"/>
        </div>
        <div class="right" style="line-height: 44px">
            <ons-toolbar-button ng-click="menu.toggleMenu()">
                <ons-icon icon="ion-navicon" style="font-size: 32px; width: 1em;"></ons-icon>
    		</ons-toolbar-button>
        </div>
    </ons-toolbar>

    <input id="pac-input" class="controls" type="text" placeholder="請輸入地點或拖曳游標" style="z-index:99999;">
    <button class="btn btn-default search_btn" id="submit-search" onClick="search()"></button>
    
    <div id="type-selector" class="controls" style="display:none" >
      <input type="radio" name="type" id="changetype-all" checked="checked">
      <label for="changetype-all">All</label>
      
      <input type="radio" name="type" id="changetype-establishment">
      <label for="changetype-establishment">Establishments</label>

      <input type="radio" name="type" id="changetype-address">
      <label for="changetype-address">Addresses</label>

      <input type="radio" name="type" id="changetype-geocode">
      <label for="changetype-geocode">Geocodes</label>
    </div>
    
    <div id="map"></div>
    
    <input value="確定" type="button" class="btn btn-default select_pos_btn" onClick="submitPos()">

    <img id="my_pos_img" src="images/smallpeopleicon_gif.gif" class="my_pos_img"/>
        
    
    
    <ons-template id="alert-dialog.html">
        <ons-alert-dialog var="alertDialog">
            <div class="alert-dialog-title">
                <strong style="color: #ff3333" id="alertDialogTitle">定位失敗!</strong>    
            </div>
            <div class="alert-dialog-content">
                <span id="alertDialogText">請確定已開啟GPS功能，並重新嘗試</span>
            </div>
            <div class="alert-dialog-footer">
                <button class="alert-dialog-button" onClick="closeDialog()">OK</button>
            </div>
        </ons-alert-dialog>
    </ons-template>

</ons-page>
 
<script>
var t;
var map;
var original_height;

ons.ready(function() {
    setTimeout(function() {

        hideFloatIcon();
        menu.setSwipeable(false);
    }, 10);
});

$(function(){

    isFirstTime = true;

    var options = {
      enableHighAccuracy: true,     // 高精度定位
	  timeout: 10000,               // 10秒 timeout
	  maximumAge: 3 * 60 * 1000     // 暫存3分鐘
	};
	
	function success(pos) {

        original_height = $(document).height();
        initMap(pos);
	};

	function error(err) {
	    
        console.warn('ERROR(' + err.code + '): ' + err.message);
        ons.createAlertDialog('alert-dialog.html').then(function(alertDialog) {
            alertDialog.show();
        });       
	};

	navigator.geolocation.getCurrentPosition(success, error, options);
});

function initMap(position) {
    
    var pos_lat = position.coords.latitude;
    var pos_lng = position.coords.longitude;
    
    var map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: parseFloat(pos_lat), lng: parseFloat(pos_lng)},
        zoom: 19,
        mapTypeControl: false
    });
    
    // 返回中心點
    var centerControlDiv = document.createElement('div');
    var centerControl = new CenterControl(centerControlDiv, map, position);
    centerControlDiv.index = 1;
    map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(centerControlDiv);

    var markerImage = new google.maps.MarkerImage('images/blue.png',
                new google.maps.Size(80, 80),
                new google.maps.Point(0, 0),
                new google.maps.Point(40, 40));
    
    // 自已的座標 
    var marker = new google.maps.Marker({
		position: {lat: position.coords.latitude, lng: position.coords.longitude},
		map: map,
        icon: markerImage,
        zIndex: 0
	});



	var markers = {};
	map.addListener('bounds_changed', function(){

        var screen_h = $(document).height();
        if(screen_h == original_height) {
        
            var bounds = map.getBounds();
        	var center = map.getCenter();
    		window.localStorage.setItem("start_center", center.lat()+","+center.lng());
            
            if (t === undefined || t === null) {
            
            } else {
                clearTimeout(t);
            }
            t = setTimeout(function(){ getPos(); }, 500);
        }
	});
    
    
    

    // 移動至輸入的地址
    var searchBox = new google.maps.places.SearchBox(document.getElementById('pac-input'));
    google.maps.event.addListener(searchBox, 'places_changed', function() {

        var place = searchBox.getPlaces()[0];    
        if (!place.geometry) return;
        if (place.geometry.viewport) {
            map.fitBounds(place.geometry.viewport);
        } else {
            map.setCenter(place.geometry.location);
            map.setZoom(16);
        }
    });

    var input = (document.getElementById('pac-input'));

    var types = document.getElementById('type-selector');
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(types);

    var autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.bindTo('bounds', map);

    var infowindow = new google.maps.InfoWindow();
    var marker = new google.maps.Marker({
        map: map,
        anchorPoint: new google.maps.Point(0, -29)
    });

    autocomplete.addListener('place_changed', function() {
        infowindow.close();
        marker.setVisible(false);
        var place = autocomplete.getPlace();
        if (!place.geometry) {
            // User entered the name of a Place that was not suggested and
            // pressed the Enter key, or the Place Details request failed.
            //window.alert("No details available for input: '" + place.name + "'");
            return;
        }

        // If the place has a geometry, then present it on a map.
        if (place.geometry.viewport) {
            map.fitBounds(place.geometry.viewport);
        } else {
            map.setCenter(place.geometry.location);
            map.setZoom(19);  // Why 17? Because it looks good.
        }
        marker.setIcon(({
            url: place.icon,
            size: new google.maps.Size(71, 71),
            origin: new google.maps.Point(0, 0),
            anchor: new google.maps.Point(17, 34),
            scaledSize: new google.maps.Size(35, 35)
        }));
        marker.setPosition(place.geometry.location);
        marker.setVisible(true);

        var address = '';
        if (place.address_components) {
            address = [
                (place.address_components[0] && place.address_components[0].short_name || ''),
                (place.address_components[1] && place.address_components[1].short_name || ''),
                (place.address_components[2] && place.address_components[2].short_name || '')
            ].join(' ');
        }

        infowindow.setContent('<div><strong>' + place.name + '</strong><br>' + address);
        infowindow.open(map, marker);
    });

    // Sets a listener on a radio button to change the filter type on Places
    // Autocomplete.
    function setupClickListener(id, types) {
        var radioButton = document.getElementById(id);
        radioButton.addEventListener('click', function() {
            autocomplete.setTypes(types);
        });
    }

    setupClickListener('changetype-all', []);
    setupClickListener('changetype-address', ['address']);
    setupClickListener('changetype-establishment', ['establishment']);
    setupClickListener('changetype-geocode', ['geocode']);
}

function CenterControl(controlDiv, map, position) {

  // Set CSS for the control border.
  var controlUI = document.createElement('div');
  controlUI.style.cursor = 'pointer';
  controlUI.style.marginRight = '8px';
  controlDiv.appendChild(controlUI);

  // Set CSS for the control interior.
  var controlText = document.createElement('div');
  controlText.innerHTML = '<img src="images/center_btn.png" style="width:30px"/>';
  controlUI.appendChild(controlText);

  // Setup the click event listeners: simply set the map to Chicago.
  controlUI.addEventListener('click', function() {
    map.setCenter({lat: position.coords.latitude, lng: position.coords.longitude});
  });
}

function getPos() {

    clearTimeout(t);
    var latlng = window.localStorage.getItem("start_center");
    
    // 依經緯度查地址
    $.getJSON('https://maps.googleapis.com/maps/api/geocode/json', {
        key: 'AIzaSyAHgoUk-vzZfk0CPhkOBNsX5fTyrCKVkh8',
    	latlng: latlng,
        location_type: "ROOFTOP",
        result_type: "street_address"
    }, function(data) {

        var formatted_address = "";
        if(data.results.length <= 0) {

            formatted_address = "";
        } else {
            
            formatted_address = data.results[0].formatted_address;

            var select_map = window.localStorage.getItem("select_map");
            if(select_map == "address") {
                $("#new_address").val(formatted_address);//.focus();
                window.localStorage.setItem("address_latlng", latlng);
            } else if(select_map == "destination") {
                $("#new_destination").val(formatted_address);//.focus();
                window.localStorage.setItem("destination_latlng", latlng);
            } else if(select_map == "airport_address") {
                $("#new_airport_address").val(formatted_address);//.focus();
                window.localStorage.setItem("address_latlng", latlng);
            }
        }

        console.log("formatted_address("+formatted_address+")");
        $("#pac-input").val(formatted_address);
    });
}

function submitPos() {

    var latlng = window.localStorage.getItem("start_center");
    
    // 依經緯度查地址
    $.getJSON('https://maps.googleapis.com/maps/api/geocode/json', {
        key: 'AIzaSyAHgoUk-vzZfk0CPhkOBNsX5fTyrCKVkh8',
        latlng: latlng,
        location_type: "ROOFTOP",
        result_type: "street_address"
    }, function(data) {

        if(data.results.length <= 0) {
         
            ons.createAlertDialog('alert-dialog.html').then(function(alertDialog) {

                $('#alertDialogText').html("請選擇正確的道路");
                alertDialog.show();
            });
            return;   
        }

        var formatted_address = data.results[0].formatted_address;
        //console.log("formatted_address("+formatted_address+")");

        var select_map = window.localStorage.getItem("select_map");
        if(select_map == "address") {
            $("#new_address").val(formatted_address);//.focus();
            window.localStorage.setItem("address_latlng", latlng);
        } else if(select_map == "destination") {
            $("#new_destination").val(formatted_address);//.focus();
            window.localStorage.setItem("destination_latlng", latlng);
        } else if(select_map == "airport_address") {
            $("#new_airport_address").val(formatted_address);//.focus();
            window.localStorage.setItem("address_latlng", latlng);
        }

        homeNavigator.popPage();
    });
}

function closeDialog() {
    alertDialog.destroy();
}

function search() {

    $('#pac-input').show(function() {
        google.maps.event.trigger(this, 'focus');
        google.maps.event.trigger(this, 'keydown', {
            keyCode: 13
        });
    });   
}

  
</script>


<script>

  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  var str = "";
  var select_map = window.localStorage.getItem("select_map");
  if(select_map == "address")     str = "上車地圖";
  else                            str = "下車地圖";

  ga('create', 'UA-84401162-1', 'auto');
  ga('send', 'pageview', '刊登共乘頁-' + str);
</script>
