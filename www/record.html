<style>
.slider_img {
    margin: 0 auto;
    height:100%;
}

.myCarousel {
    text-align: center;
}

.mySection {
    padding: 16px; 
    border: rgba(0,0,0,0.2) 1px solid;
    -webkit-border-radius: 5px;
    -moz-border-radius: 5px;
    border-radius: 5px;
}

.text1 {
    color:#aaa8a8;
    width:20%;
    display: inline-flex;
}
.text2 {
    color:#686d6d;
    width: 80%;
    display: inline-flex;
}
</style>

<ons-navigator title="Navigator" var="page6Navigator">
    <ons-page style="background:#fff;">
    
        <ons-toolbar fixed-style>
            <!--
            <div class="left" style="line-height: 44px">
                <img src="images/logo.png" style="height:32px; margin-left:10px;" onClick="gotoPage1()"/>
            </div>
            -->
            <div class="center">
                <img src="images/go2gether.png" style="height:32px;"/>
            </div>
            <div class="right" style="line-height: 44px">
                <ons-toolbar-button ng-click="menu.toggleMenu()">
                    <ons-icon icon="ion-navicon" style="font-size: 32px; width: 1em;"></ons-icon>
            	</ons-toolbar-button>
            </div>
        </ons-toolbar>

        <section style="padding: 0px 16px 0 16px" class="radio_box">
            <h3>刊登記錄</h3>
        </section>

        <div style="clear:both; height:10px"></div>

        <div class="container">
            <div id="history" class="tab-pane">載入中…</div>
        </div>

        <ons-template id="alert-dialog.html">
            <ons-alert-dialog var="alertDialog">
                <div class="alert-dialog-content">
                    請先登入您的Facebook帳號
                </div>
                <div class="alert-dialog-footer">
                    <button class="alert-dialog-button" onClick="needLogin()">確定</button>
                </div>
            </ons-alert-dialog>
        </ons-template>

    </ons-page>
</ons-navigator>

<script>
    var t;
    ons.ready(function() {
        setTimeout(function() {

            //window.localStorage.setItem("facebook_id", "100008708199178");
            // 檢查 facebook 是否已登入
            if(window.localStorage.getItem("facebook_id") == "" || window.localStorage.getItem("facebook_id") == null ) {
                
                ons.createAlertDialog('alert-dialog.html').then(function(alertDialog) {
                    alertDialog.show();
                });

                return;
            }

            var fb_id = window.localStorage.getItem("facebook_id");

            // 記錄
            var snapshots = new Array();
            areas.orderByChild("fb_id").equalTo(fb_id).on("child_added", function(snapshot) {

                // 時間
                var d1 = new Date(snapshot.val().appointment).getTime();
                if(_begin_time >= d1 && d1 <= _end_time) {

                    var temp = new Array(2);
                    temp[0] = d1;
                    temp[1] = snapshot;
                    snapshots.push(temp);
                        
                    if (t === undefined || t === null) {
    
                    } else {
                        clearTimeout(t);
                    }
                    t = setTimeout(function(){ next(); }, 100);
                }
            });

            function next() {

                snapshots = snapshots.sort(function(a,b) {
                    return a[0] - b[0];
                });
                
                for(var i=0; i<snapshots.length; i++) {

                    var snapshot = snapshots[i][1];

                    var key = snapshot.key;
                    //console.log("key("+snapshot.key+")");
    
                    // 時間
                    var d1 = new Date(snapshot.val().appointment);
        			var time_text = getTimeStr(d1); //d1.toLocaleString();
    
                    // 過期時間
                    var d2 = new Date(snapshot.val().expired_time); 
                    var expired_time_text = getTimeStr(d2);//d2.toLocaleString();
    
                    var d = new Date();
                    var now_text = d.toLocaleString();
    
                    var text = "";
                    text += '<div style="clear:both; height:10px"></div>';

                    if(i == 0)   $('#history').empty();
    
                    text += "<section class='mySection' onClick='setInfo(\""+snapshot.val().input_address+"\", \""+snapshot.val().destination+"\")'>";
                    text +=     '<div><span class="text1">出發</span><span class="text2">'+snapshot.val().input_address+'</span></div>';
                    text +=     '<div><span class="text1">目的</span><span class="text2">'+snapshot.val().destination+'</span></div>';
                    text +=     '<div><span class="text1">時間</span><span class="text2">'+time_text+'</span></div>';
                    text +=     '<div><span class="text1">備註</span><span class="text2">'+snapshot.val().note+'</span></div>';
                    text += '</section>';
    
                    $('#history').append(text);
                }
            }
        }, 10);
    });

    function setInfo(address, destination) {

        console.log("address("+address+") destination("+destination+")");

        $("#address").val(address);
        $("#destination").val(destination);
        
        homeNavigator.popPage();
    }
    
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-84401162-1', 'auto');
  ga('send', 'pageview', '刊登記錄頁');
</script>