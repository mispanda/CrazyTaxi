<style>
    .radio_box li  {
        display: block;
        float: left;
        margin-right:10px;
    }
    
    .radio_box li label {
        margin-left:5px;
    }
    .text-input {
        border-radius:0;
        display: block; 
        width: 100%
    }
    .submit_btn {
        background-color: rgba(24,103,194,0.81);
        border: 0;
        font-size: 16px;
        font-weight: 500;
        line-height: 36px;
        padding: 4px 12px;
        display: block;
        width: 100%;
        text-align: center;
        color: #FFF;
    }
</style>

<ons-navigator title="Navigator" var="homeNavigator">
    <ons-page style="background:#fff;">
    
        <ons-toolbar>
            <div class="left" style="line-height: 44px">
                <img src="images/logo.png" style="height:18px; margin-left:10px;"/>
            </div>
            <div class="center">
                <img src="images/go2gether.png" style="height:32px;"/>
            </div>
            <div class="right" style="line-height: 44px">
                <ons-toolbar-button ng-click="menu.toggleMenu()">
                    <ons-icon icon="ion-navicon" style="font-size: 32px; width: 1em;"></ons-icon>
        		</ons-toolbar-button>
            </div>
        </ons-toolbar>
        
        
        <form id="add" action="#">
            <section style="padding: 8px 16px 4px 16px">
                <div>設定共乘條件</div>
            </section>
    		<section style="padding: 4px 16px">
                <input type="text" class="text-input" ng-model="address" placeholder="請輸入上車地點" id="address" required>
            </section>
            <section style="padding: 4px 16px">
                <input type="text" class="text-input" ng-model="destination" placeholder="請輸入下車地點" id="destination" required>
            </section>
            <section style="padding: 4px 16px">
                <input type="text" class="text-input" ng-model="startDate" placeholder="請輸入出發日期" id="datepicker" data-role="date" required>
            </section>
            <section style="padding: 4px 16px">
                <input type="text" class="text-input" ng-model="startTime" placeholder="請輸入出發時間" id="timepicker" required>
            </section>
            <section style="padding: 4px 16px">
                <input type="text" class="text-input" ng-model="phones" placeholder="請輸入手機號碼" id="phones" required>
            </section>
            <section style="padding: 4px 16px">
                <input type="text" class="text-input" ng-model="note" placeholder="其餘特殊需求備註" id="note">
            </section>
            
            <div style="clear:both; height:10px"></div>
            
            <section style="padding: 0px 16px 0 16px" class="radio_box">
                <div>請選擇您本次共乘目的</div>
                <li><input type="radio" name="purpose" value="通勤" required><label>通勤</label></li>
                <li><input type="radio" name="purpose" value="認識朋友"><label for="input1">認識朋友</label></li>
                <li><input type="radio" name="purpose" value="抓寶可夢"><label for="input1">抓寶可夢</label></li>
                <div style="clear:both;"></div>
                <li><input type="radio" name="purpose" value="業務"><label for="input1">業務</label></li>
                <li><input type="radio" name="purpose" value="機場接送"><label for="input1">機場接送</label></li>
                <li><input type="radio" name="purpose" value="其他___"><label for="input1">其他___</label></li>
            </section>

            <div style="clear:both; height:5px"></div>
            
            <section style="padding: 4px 16px" class="radio_box">
                <input type="checkbox" id="agree_check" required/><span style="margin-left:5px">我同意此次共乘車資，與共乘夥伴依照跳錶金額平均分攤</span>
            </section>
        
            <section style="padding: 0px 16px" class="radio_box">                
                <input type="submit" value="確定" class="btn btn-default submit_btn">
            </section>
		</form>

        <ons-template id="alert-dialog.html">
            <ons-alert-dialog var="alertDialog">
                <div class="alert-dialog-content">
                    <span id="alertDialogText">請先登入帳號</span>
                </div>
                <div class="alert-dialog-footer">
                    <button class="alert-dialog-button" onClick="needLogin()">OK</button>
                </div>
            </ons-alert-dialog>
        </ons-template>

    </ons-page>
</ons-navigator>

<script>
    //window.localStorage.setItem("facebook_id", "100000151115805");

    ons.ready(function() {

        setTimeout(function() {
            
            // 檢查 facebook 是否已登入
            if(window.localStorage.getItem("facebook_id") == "" || window.localStorage.getItem("facebook_id") == null ) {
                
                ons.createAlertDialog('alert-dialog.html').then(function(alertDialog) {
                    $('#alertDialogText').html("請先登入帳號");
                    alertDialog.show();
                });
                
                /*
                ons.notification.confirm({
                    message: '登入Facebook帳號',
                    modifier: undefined,
                    callback: function(idx) {
                        switch (idx) {
                        case 0:
                            console.log("Cancel");
                            gotoPage1();
                            break;
                        case 1:
                            console.log("OK");
                            FB.login(function(response) {
                                checkLoginState();
                            });
                            break;
                        }
                    }
                });
                */
                
                return;
            }

            // 檢查是否被禁止刊登
            is_fb_player_enable();

            var latlng = window.localStorage.getItem("center");
            // 依經緯度查地址
            $.getJSON('https://maps.googleapis.com/maps/api/geocode/json', {
            		key: 'AIzaSyAHgoUk-vzZfk0CPhkOBNsX5fTyrCKVkh8',
        			latlng: latlng,
                    location_type: "ROOFTOP",
                    result_type: "street_address"
        		}, function(data) {
                    console.log(data);
                    var formatted_address = data.results[0].formatted_address;
                    console.log("formatted_address("+formatted_address+")");
                    $("#address").val(formatted_address);
        		}
            );

            $("#datepicker").datepicker({ minDate: 0, maxDate: "+2D" });
            $('#timepicker').wickedpicker();
            
            isFirstTime = true;

            $('#add').on('submit', function() {
                
                console.log("facebook_id("+window.localStorage.getItem("facebook_id")+")");
                
        		var address = $('input#address').val();				    // 上車地點
        		var destination = $('input#destination').val();		    // 下車地點
        		var startDate = $('input#datepicker').val();			// 出發日期
        		var startTime = $('input#timepicker').val();			// 出發時間
        		var phones = $('input#phones').val();					// 手機號碼
        		var note = $('input#note').val();						// 備註
        		var purpose = $('input[name=purpose]:checked').val();	// 共乘目的
                /*
        		console.log("address("+address+")");
        		console.log("destination("+destination+")");
        		console.log("startDate("+startDate+")");
        		console.log("startTime("+startTime+")");
        		console.log("phones("+phones+")");
        		console.log("note("+note+")");
        		console.log("purpose("+purpose+")");
                */
        		$.getJSON('https://maps.googleapis.com/maps/api/geocode/json', {
        			key: 'AIzaSyAHgoUk-vzZfk0CPhkOBNsX5fTyrCKVkh8',
        			address: address	// 上車地點
        		}, function(data) {
        			
        			//parse address
        			var c, point_of_interest, area = {
        				name: destination,		// 下車地點
        				latitude: data.results[0].geometry.location.lat,
        				longitude: data.results[0].geometry.location.lng,
        			};
        
        			//get address, city and state
        			for (var i = 0; i < data.results[0].address_components.length; i++) {
        				c = data.results[0].address_components[i];
        				if (!c.types.length || c.types[0] == 'point_of_interest') {
        					//record the point of interest in case address is empty
        					point_of_interest = c.short_name;
        				} else if (c.types.indexOf('street_number') !== -1) {
        					//set address as street number
        					area.address = c.long_name;
        				} else if (c.types.indexOf('route') !== -1) {
        					//append street name
        					area.address += ' ' + c.long_name;
        					area.address = area.address.trim();
        				} else if (c.types.indexOf('locality') !== -1) {
        					area.city = c.long_name;
        				} else if (c.types.indexOf('sublocality') !== -1) {
        					if (!area.city) area.city = c.long_name;
        				} else if (c.types.indexOf('administrative_area_level_3') !== -1) {
        					if (!area.city) area.city = c.long_name;
        				} else if (c.types.indexOf('administrative_area_level_1') !== -1) {
        					area.state = c.short_name;
        				} else if (c.types.indexOf('postal_code') !== -1) {
        					area.postal_code = c.short_name;
        				} else if (c.types.indexOf('country') !== -1) {
        					area.country = c.short_name;
        				}
        			}

        			// facebook user id
        			area.fb_id = window.localStorage.getItem("facebook_id");
                    area.fb_name = window.localStorage.getItem("facebook_name");
                    area.fb_mail = window.localStorage.getItem("facebook_mail");

        			area.input_address = address;		// 上車地點
        			area.destination = destination;	    // 下車地點
        			area.phones = phones;				// 手機號碼
        			area.note = note;					// 備註
        			area.purpose = purpose;			    // 共乘目的

        			// 建立時間
        			var d = new Date();
        			area.timestamp = d.getTime();

                    // 時間處理
                    date_txt = startDate.replace(/\//g,"-");
                    //console.log("startDate("+startDate+") startTime("+startTime+")");

                    var words = startTime.split(' ');
                    var hours = words[0];
                    var minutes = words[2];
                    var am_pm = words[3];
                    if(am_pm == "PM")   hours = Math.floor(hours) + 12;
                    var time_txt = hours+":"+minutes+":00";
                    var txt = date_txt + " " + time_txt;

                    var d = new Date(txt);

                    // 預約時間
                    area.appointment = d.getTime();

                    // 過期時間 = 預約時間 + 10分鐘
                    d.setMinutes(d.getMinutes() + 10);
        			area.expired_time = d.getTime();
                    
                    // 排序用
                    area.priority = 0 - Math.floor( d.getTime() + d.getMilliseconds() + i );
                    //console.log("appointment("+d.toString()+") expired_time("+d.toString()+")");
                    area.status = "";

        			if (!area.address && point_of_interest) area.address = point_of_interest;

        			//persist to firebase
        			var area_id = firebase.database().ref().child('areas').push().key;
        			var updates = {};
        			updates['/areas/' + area_id] = area;
        			firebase.database().ref().update(updates);

        			//geofire
        			geoFire.set(area_id, [area.latitude, area.longitude]).then(function() {
        				//console.log(area_id + ': setting position to [' + area.latitude + ',' + area.longitude + ']');
        			});
                    
                    // fb player 
                    var fb_player = {name: ""};
                    fb_player.name = window.localStorage.getItem("facebook_name");
                    fb_player.enable = true;
                    fb_player.priority = 0 - Math.floor( d.getTime() + d.getMilliseconds() );        // 排序用
                    var player_updates = {};
                    player_updates['/players/' + window.localStorage.getItem("facebook_id")] = fb_player;
            		firebase.database().ref().update(player_updates);

        			//clean up form
        			$('form#add').trigger('reset');

                    // 跳至完成刊登頁
                    homeNavigator.pushPage("page2_success.html", {animation: 'slide'});
        		});

               return false;
            });	
            
        }, 10);
    });

    function stringToDate(_date,_format,_delimiter)
    {
        var formatLowerCase=_format.toLowerCase();
        var formatItems=formatLowerCase.split(_delimiter);
        var dateItems=_date.split(_delimiter);
        var monthIndex=formatItems.indexOf("mm");
        var dayIndex=formatItems.indexOf("dd");
        var yearIndex=formatItems.indexOf("yyyy");
        var month=parseInt(dateItems[monthIndex]);
        month-=1;
        var formatedDate = new Date(dateItems[yearIndex],month,dateItems[dayIndex]);
        return formatedDate;
    }

    function needLogin() {
        alertDialog.hide();
        gotoPage1();
    }
        
    function is_fb_player_enable() {

        //console.log("is_fb_player_enable ==> facebook_id("+window.localStorage.getItem("facebook_id")+")");
        var key = window.localStorage.getItem("facebook_id");
        players.child(key).once('value', function(snapshot) {

            if(snapshot.exists() == true) {

                var enable = snapshot.val().enable;
                var name = snapshot.val().name;
                //console.log("enable("+enable+") name("+name+")");

                if(enable != true) {

                    ons.createAlertDialog('alert-dialog.html').then(function(alertDialog) {

                        $('#alertDialogText').html("你被禁止刊登，請稍候再試，謝謝!");
                        alertDialog.show();
                    });
                }
            }
        });
    }

</script>