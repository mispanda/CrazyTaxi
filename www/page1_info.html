<style>
#fb_user_picture {
    -webkit-border-radius: 60px;
    -moz-border-radius: 60px;
    border-radius: 60px;
    BORDER: #c9c9c9 2px solid;
}
.submit_btn {
    background-color: rgba(24,103,194,0.81);
    border: 0;
    font-size: 16px;
    font-weight: 500;
    line-height: 36px;
    padding: 4px 12px;
    display: block;
    width: 100%;
    text-align: center;
    color: #FFF;
}
</style>

<ons-page style="background:#fff;">

    <ons-toolbar fixed-style>
        <div class="left" style="line-height: 44px;">
            <ons-back-button></ons-back-button>
        </div>
        <div class="center">
            <img src="images/go2gether.png" style="height:32px;"/>
        </div>
        <div class="right" style="line-height: 44px">
            <ons-toolbar-button ng-click="menu.toggleMenu()">
        		<ons-icon icon="ion-navicon" style="font-size: 32px; width: 1em;"></ons-icon>
    		</ons-toolbar-button>
        </div>
    </ons-toolbar>
        
        <div style="clear:both; height:10px"></div>

        <!-- facebook 頭像及名稱 -->
        <section style="padding: 4px 16px; text-align:center;">
            <img id="fb_user_picture"/>
            <div id="fb_user_name"></div>
        </section>
        
        <div style="clear:both; height:10px"></div>
         
        <section class="section1">
            <div style="color:#b5b2b2;">上車地點</div>
            <div id="input_address_div" style="color:#6b6b6b;"></div>
        </section>
        
        <section class="section1">
            <div style="color:#b5b2b2;">下車地點</div>
            <div id="destination_div" style="color:#6b6b6b;"></div>
        </section>
        
        <section class="section1">
            <div style="color:#b5b2b2;">出發時間</div>
            <div id="time_div" style="color:#6b6b6b;"></div>
        </section>
        
        <section class="section1">
            <div style="color:#b5b2b2;">共乘目的</div>
            <div id="purpose_div" style="color:#6b6b6b;"></div>
        </section>
        
        <section class="section1">
            <div style="color:#b5b2b2;">備註</div>
            <div id="note_div" style="color:#6b6b6b;"></div>
        </section>
        
        <form id="add">
            <section style="padding: 4px 16px" class="radio_box">
                <input type="checkbox" name="ck_1" required/><span style="margin-left:5px"><span id="ck_1_span">我同意此次共乘車資，與共乘夥伴依照跳錶金額平均分攤</span></span>
            </section>
    
            <section style="padding: 4px 16px" class="radio_box">
                <input type="checkbox" name="ck_2" required/><span style="margin-left:5px"><span id="ck_2_span">我已詳細閱讀並同意本活動之</span><a onClick="page7_click()" style="cursor: pointer;">服務條款</a>及<a onClick="page4_click()" style="cursor: pointer;">活動說明</a></span>
            </section>

            <div style="clear:both; height:10px"></div>
  
            <section style="padding: 0px 16px" class="radio_box">                
                <input type="submit" value="聯繫對方" class="btn btn-default submit_btn">
            </section>
        </form>
        
        <div id="self_div" style="display:none;">
            <section class="section1">
                <div style="color:#b5b2b2;">小幫手</div>
                <div id="note_div" style="color:#6b6b6b;">*已找到共乘夥伴，卻還是一直收到共乘聯繫時，可使用下方按鈕【已找到共乘夥伴】，系統將會自動隱藏您的共乘需求。<span style="color:#F00;">(注意！此功能並非取消共乘！）</span></div>
            </section>
        
            <div style="clear:both; height:10px"></div>
        
            <section style="padding: 4px 16px; text-align:center;">
                <ons-button id="done_btn" class="button button--large" modifier="chevron" onclick="page1InfoClick('已找到共乘夥伴')" style="background:#36d0c9; border-radius:0;">
                    <span style="font-size:18px">已找到共乘夥伴</span>
                </ons-button>
        
                <div style="clear:both; height:10px"></div>
        
                <ons-button id="cancel_btn" class="button button--large" modifier="chevron" onclick="page1InfoClick('取消此次共乘')" style="background:#adadad; border-radius:0;">
                    <span style="font-size:18px">取消此次共乘</span>
                </ons-button>
            </section>
        </div>
        
</ons-page>

<ons-template id="alert-dialog.html">
    <ons-alert-dialog var="alertDialog">
        <div class="alert-dialog-content">
            <span id="page1AlertDialogText">請先登入您的Facebook帳號</span>
        </div>
        <div class="alert-dialog-footer">
            <button id="dialog_btn" class="alert-dialog-button" onClick="needLogin()">確定</button>
        </div>
    </ons-alert-dialog>
</ons-template>

<script>

function page1InfoClick(pageName) {
    
    switch(pageName) {
    case "聯繫對方":                    contact_btn();              break;
    case "Facebook messenger 聯繫":     fb_messenger_btn();         break;
    case "簡訊聯繫":                    sms_btn();                  break;
    case "電話聯繫":                    phone_click();              break;
    case "電子信箱聯繫":                email_btn();                break;
    case "已找到共乘夥伴":              done_btn();                 break;
    case "取消此次共乘":                cancel_btn();               break;
    }

    ga('send', 'event', '共乘條件頁', 'click', pageName);
}

    ons.ready(function() {
        setTimeout(function() {
            
            //window.localStorage.setItem("facebook_id", "1389354124412945");

            // 檢查 facebook 是否已登入
            if(window.localStorage.getItem("facebook_id") == "" || window.localStorage.getItem("facebook_id") == null ) {

                ons.createAlertDialog('alert-dialog.html').then(function(alertDialog) {

                    $('#page1AlertDialogText').html("請先登入您的Facebook帳號");
                    alertDialog.show();
                });

                return;
            }

            is_fb_player_enable();

            showInfo();
     
            
            $('#ck_1_span').click(function() {

                var ck_1 = $('input[name=ck_1]:checked');
                if(ck_1.length > 0)     $('input[name=ck_1]').prop("checked", false);
                else                    $('input[name=ck_1]').prop("checked", true);
            });
            
            $('#ck_2_span').click(function() {

                var ck_2 = $('input[name=ck_2]:checked');
                if(ck_2.length > 0)     $('input[name=ck_2]').prop("checked", false);
                else                    $('input[name=ck_2]').prop("checked", true);
            });
            
            
            $('#add').submit(function(e) {

                var ck_1 = $('input[name=ck_1]:checked');
                var ck_2 = $('input[name=ck_2]:checked');
                if(ck_1.length <= 0) {
                   
                    ons.createAlertDialog('alert-dialog.html').then(function(alertDialog) {
    
                        $('#page1AlertDialogText').html('請勾選"我同意此次共乘車資，與共乘夥伴依照跳錶金額平均分攤"');
                        $("#dialog_btn").attr("onclick","closeDialog()");
                        alertDialog.show();
                    });
                    return false;
                } else if(ck_2.length <= 0) {
                
                   ons.createAlertDialog('alert-dialog.html').then(function(alertDialog) {
    
                        $('#page1AlertDialogText').html('請勾選"我已詳細閱讀並同意本活動之服務條款及活動說明"');
                        $("#dialog_btn").attr("onclick","closeDialog()");
                        alertDialog.show();
                    });
                    return false;
                }

                page1InfoClick('聯繫對方');
                event.preventDefault();
            });

        }, 10);
    });
    

    var fb_id = "";
    var phones = "";
    var emai = "";
    var fb_name = "";
    var destination = "";
    function showInfo() {
        
        //var key = "-KRRNVxXNetIAj6aXiZL";
        var key = window.localStorage.getItem("info_key");
        
        areas.child(key).on('value', function(snapshot) {
    					
			//console.log(snapshot.val());
			fb_id = snapshot.val().fb_id;                       // facebook user id
            fb_name = snapshot.val().fb_name;                   // facebook user name
            var input_address = snapshot.val().input_address;   // 上車地點
            destination = snapshot.val().destination;           // 下車地點
			var timestamp = snapshot.val().appointment;		    // 共乘時間
			var purpose = snapshot.val().purpose;			    // 共乘目的
            var note = snapshot.val().note;    		            // 備註
            phones = snapshot.val().phones;        	            // 手機
            email = snapshot.val().email;                       // 電子信箱

			var d = new Date(timestamp);
			var time_text = getTimeStr(d); //d.toLocaleString();
		    
            var fb_image = "https://graph.facebook.com/"+fb_id+"/picture?type=normal";
            //console.log("fb_image("+fb_image+")");
            $('#fb_user_picture').attr("src", fb_image);
			$('#fb_user_name').text(fb_name);			
            $('#input_address_div').text(input_address);
            $('#destination_div').text(destination);
            $('#time_div').text(time_text);
            $('#purpose_div').text(purpose);
            $('#note_div').text(note);
            
            
             
            var facebook_id = window.localStorage.getItem("facebook_id");
            console.log("facebook_id("+facebook_id+") fb_id("+fb_id+")");
            if(fb_id == facebook_id) {
                
                $("#add").hide();
                $("#self_div").show();
            }
            
		});
        
        
    }
    
    function contact_btn() {

        var message = "";
            message +=  '<div class="pop_message">';
            /*
            message +=  '<section class="section1">';
            message +=      "<ons-button class='button button--large' modifier='chevron' onclick='page1InfoClick(\"Facebook messenger 聯繫\")' style='background:#36d0c9; border-radius:0;'>";
            message +=          '<span style="font-size:18px">Facebook messenger 聯繫</span>';
            message +=      '</ons-button>';
            message +=  '</section>';
            */

            message +=  '<section class="section1">';
            message +=      "<ons-button class='button button--large' modifier='chevron' onclick='page1InfoClick(\"電子信箱聯繫\")' style='background:#36d0c9; border-radius:0;'>";
            message +=          '<span style="font-size:18px">電子信箱聯繫</span>';
            message +=      '</ons-button>';
            message +=  '</section>';

            message +=  '<section class="section1">';
            message +=      "<ons-button class='button button--large' modifier='chevron' onclick='page1InfoClick(\"簡訊聯繫\")' style='background:#36d0c9; border-radius:0;'>";
            message +=          '<span style="font-size:18px">簡訊聯繫</span>';
            message +=      '</ons-button>';
            message +=  '</section>';

            message +=  '<section class="section1">';
            message +=      "<ons-button class='button button--large' modifier='chevron' onclick='page1InfoClick(\"電話聯繫\")' style='background:#36d0c9; border-radius:0;'>";
            message +=          '<span style="font-size:18px">電話聯繫</span>';
            message +=      '</ons-button>';
            message +=  '</section>';

            message +=  '<section class="section1">';
            message +=      '<ons-button class="button button--large" modifier="chevron" onclick="HoldOn.close()" style="background:#adadad; border-radius:0;">';
            message +=          '<span style="font-size:18px">取消</span>';
            message +=      '</ons-button>';
            message +=  '</section>';
            message +=  '</div>';

        options = {
            theme: "custom",
            message: message,
            textColor: "white"
        };
            
        HoldOn.open(options);
    }
    
    function fb_messenger_btn() {

        window.location = "https://m.me/" + fb_id;
    }
    
    function sms_btn() {

        //var message = "Hi " + fb_name + " 一起共乘去" + destination + "吧~~";
        window.location = "sms:" + phones;// + "&body=" + message;
    }

    function phone_click() {

        window.location = "tel:" + phones;
    }

    function email_btn() {
        console.log("email_btn click")
        window.location.href = "mailto:" + email + "?subject=大車隊共乘&body=Hi " + fb_name + " 一起共乘去" + destination + "吧~~";
    }

    function is_fb_player_enable() {
    
        var key = window.localStorage.getItem("facebook_id");
        players.child(key).once('value', function(snapshot) {
    
            if(snapshot.exists() == true) {
    
                var enable = snapshot.val().enable;
                var name = snapshot.val().name;
                //console.log("enable("+enable+") name("+name+")");
    
                if(enable != true) {
    
                    ons.createAlertDialog('alert-dialog.html').then(function(alertDialog) {
    
                        $('#page1AlertDialogText').html("帳號因違反使用者規範，詳細請洽客服");
                        $("#dialog_btn").attr("onclick","reload()");
                        alertDialog.show();
                    });
                }
            }
        });
    }

    function page7_click() {

        homeNavigator.pushPage("page7.html", {animation: 'slide'});
    }
    
    function page4_click() {

        tabbar.setActiveTab(3)
    }
    
    function closeDialog() {
        alertDialog.destroy();
    }

    function done_btn() {

        var key = window.localStorage.getItem("info_key");
        //console.log("done_btn ==> key("+key+")");
        
        areas.child(key).once("value", function(snapshot) {

    		updateStatus(snapshot, "done");
            gotoPage1();
		});
    }
    
    function cancel_btn() {

        var key = window.localStorage.getItem("info_key");
        //console.log("cancel_btn ==> key("+key+")");

        areas.child(key).once("value", function(snapshot) {

    		updateStatus(snapshot, "cancel");
            gotoPage1();
		});
    }
    
    function updateStatus(snapshot, status) {
        
        //console.log("click ==> snapshot.key("+snapshot.key+")");
        var area = {};
        area.address = snapshot.val().address ? snapshot.val().address : "";
        area.appointment = snapshot.val().appointment ? snapshot.val().appointment : "";
        area.city = snapshot.val().city ? snapshot.val().city : "";
        area.country = snapshot.val().country ? snapshot.val().country : "";
        area.destination = snapshot.val().destination ? snapshot.val().destination : "";
        area.expired_time = snapshot.val().expired_time ? snapshot.val().expired_time : "";
        area.fb_id = snapshot.val().fb_id ? snapshot.val().fb_id : "";
        area.fb_name = snapshot.val().fb_name ? snapshot.val().fb_name : "";
        area.input_address = snapshot.val().input_address ? snapshot.val().input_address : "";
        area.latitude = snapshot.val().latitude ? snapshot.val().latitude : "";
        area.longitude = snapshot.val().longitude ? snapshot.val().longitude : "";
        area.name = snapshot.val().name ? snapshot.val().name : "";
        area.note = snapshot.val().note ? snapshot.val().note : "";
        area.phones = snapshot.val().phones ? snapshot.val().phones : "";
        area.postal_code = snapshot.val().postal_code ? snapshot.val().postal_code : "";
        area.priority = snapshot.val().priority ? snapshot.val().priority : "";
        area.purpose = snapshot.val().purpose ? snapshot.val().purpose : "";
        area.state = snapshot.val().state ? snapshot.val().state : "";
        area.timestamp = snapshot.val().timestamp ? snapshot.val().timestamp : "";
        area.status = status;

		var area_updates = {};
		area_updates['/areas/' + snapshot.key] = area;
		firebase.database().ref().update(area_updates);
        
        // 清除 makers
        firebaseRef.child(snapshot.key).remove();
    }
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-84401162-1', 'auto');
  ga('send', 'pageview', '共乘條件頁');
</script>