<style>
#fb_user_picture {
    -webkit-border-radius: 60px;
    -moz-border-radius: 60px;
    border-radius: 60px;
    BORDER: #c9c9c9 2px solid;
    width: 120px;
    height: 120px;
}
.submit_btn {
    background-color: rgba(24,103,194,0.81);
    border: 0;
    font-size: 16px;
    font-weight: 500;
    line-height: 36px;
    padding: 4px 12px;
    display: block;
    width: 100%;
    text-align: center;
    color: #FFF;
}
</style>

<ons-page style="background:#fff;">

    <ons-toolbar fixed-style>
        <div class="left" style="line-height: 44px;">
            <ons-back-button onclick="page1_info_back()"></ons-back-button>
        </div>
        <div class="center">
            <img src="images/go2gether.png" style="height:32px;"/>
        </div>
        <div class="right" style="line-height: 44px">
            <ons-toolbar-button ng-click="menu.toggleMenu()">
        		<ons-icon icon="ion-navicon" style="font-size: 32px; width: 1em;"></ons-icon>
    		</ons-toolbar-button>
        </div>
    </ons-toolbar>

    <div style="clear:both; height:10px"></div>

    <!-- facebook 頭像及名稱 -->
    <section style="padding: 4px 16px; text-align:center;">
        <img id="fb_user_picture"/>
        <div id="fb_user_name"></div>
    </section>
        
    <div style="clear:both; height:10px"></div>
 
    <section class="section1">
        <div style="color:#b5b2b2;">上車地點</div>
        <div id="input_address_div" style="color:#6b6b6b;"></div>
    </section>
        
    <section class="section1">
        <div style="color:#b5b2b2;">下車地點</div>
        <div id="destination_div" style="color:#6b6b6b;"></div>
    </section>

    <section class="section1">
        <div style="color:#b5b2b2;">出發時間</div>
        <div id="time_div" style="color:#6b6b6b;"></div>
    </section>
        
    <section class="section1">
        <div style="color:#b5b2b2;">共乘目的</div>
        <div id="purpose_div" style="color:#6b6b6b;"></div>
    </section>
        
    <section class="section1">
        <div style="color:#b5b2b2;">備註</div>
        <div id="note_div" style="color:#6b6b6b;"></div>
    </section>
        
    <form id="page1_info_form">
        <section style="padding: 4px 16px" class="radio_box">
            <input type="checkbox" name="ck_1" required/><span style="margin-left:5px"><span id="ck_1_span">我同意共乘車資依照跳錶金額平均分攤，並同意本活動之</span><a onClick="page7_click()" style="cursor: pointer;">服務條款</a>及<a onClick="page4_click()" style="cursor: pointer;">活動說明</a></span></span>
        </section>
        <div style="clear:both; height:10px"></div>
  
        <section style="padding: 0px 16px" class="radio_box">                
            <input type="submit" value="聯繫對方" class="btn btn-default submit_btn">
        </section>
            
        <div style="clear:both; height:30px"></div>
    </form>
        
    <div id="self_div" style="display:none;">
        <section class="section1">
            <div style="color:#b5b2b2;">小幫手</div>
            <div id="note_div" style="color:#6b6b6b;">*已找到共乘夥伴，卻還是一直收到共乘聯繫時，可使用下方按鈕【已找到共乘夥伴】，系統將會自動隱藏您的共乘需求。<span style="color:#F00;">(注意！此功能並非取消共乘！）</span></div>
        </section>

        <div style="clear:both; height:10px"></div>
        
        <section style="padding: 4px 16px; text-align:center;">
            <ons-button id="done_btn" class="button button--large" modifier="chevron" onclick="page1InfoClick('已找到共乘夥伴')" style="background:#36d0c9; border-radius:0;">
                <span style="font-size:18px">已找到共乘夥伴</span>
            </ons-button>
        
            <div style="clear:both; height:10px"></div>

            <ons-button id="cancel_btn" class="button button--large" modifier="chevron" onclick="page1InfoClick('取消此次共乘')" style="background:#adadad; border-radius:0;">
                <span style="font-size:18px">取消此次共乘</span>
            </ons-button>
        </section>
    </div>    
</ons-page>

<ons-template id="alert-dialog.html">
    <ons-alert-dialog var="alertDialog">
        <div class="alert-dialog-content">
            <span id="page1AlertDialogText">請先登入您的Facebook帳號</span>
        </div>
        <div class="alert-dialog-footer">
            <button id="dialog_btn" class="alert-dialog-button" onClick="needLogin()">確定</button>
        </div>
    </ons-alert-dialog>
</ons-template>

<script>

    function page1InfoClick(pageName) {

        switch(pageName) {
        case "聯繫對方":                    contact_btn();              break;
        case "Facebook messenger 聯繫":     fb_messenger_btn();         break;
        case "簡訊聯繫":                    sms_btn();                  break;
        case "電話聯繫":                    phone_click();              break;
        case "電子信箱聯繫":                email_btn();                break;
        case "已找到共乘夥伴":              done_btn();                 break;
        case "取消此次共乘":                cancel_btn();               break;
        }

        ga('send', 'event', '共乘條件頁', 'click', pageName);
    }

    ons.ready(function() {
        setTimeout(function() {
            
            HoldOn.close();
            $("#event_div").hide();
            $("#download-btn").hide();

            // 檢查 facebook 是否已登入
            if(window.localStorage.getItem("facebook_id") == "" || window.localStorage.getItem("facebook_id") == null ) {

                ons.createAlertDialog('alert-dialog.html').then(function(alertDialog) {

                    $('#page1AlertDialogText').html("請先登入您的Facebook帳號");
                    alertDialog.show();
                });

                return;
            }

            is_fb_player_enable();

            showInfo();

            $('#ck_1_span').click(function() {

                var ck_1 = $('input[name=ck_1]:checked');
                if(ck_1.length > 0)     $('input[name=ck_1]').prop("checked", false);
                else                    $('input[name=ck_1]').prop("checked", true);
            });
            
            $('#page1_info_form').submit(function(e) {

                var ck_1 = $('input[name=ck_1]:checked');
                if(ck_1.length <= 0) {
                   
                    ons.createAlertDialog('alert-dialog.html').then(function(alertDialog) {
    
                        $('#page1AlertDialogText').html('請勾選"我同意此次共乘車資，與共乘夥伴依照跳錶金額平均分攤"');
                        $("#dialog_btn").attr("onclick","closeDialog()");
                        alertDialog.show();
                    });
                    return false;
                }

                page1InfoClick('聯繫對方');
                event.preventDefault();
            });

        }, 10);
    });
    
    var fb_id = "";
    var phones = "";
    var emai = "";
    var fb_name = "";
    var destination = "";
    var input_address = "";
    var time_text = "";
    function showInfo() {

        var key = window.localStorage.getItem("info_key");
        
        areas.child(key).on('value', function(snapshot) {

			fb_id = snapshot.val().fb_id;                       // facebook user id
            fb_name = snapshot.val().fb_name;                   // facebook user name
            input_address = snapshot.val().input_address;       // 上車地點
            destination = snapshot.val().destination;           // 下車地點
			var timestamp = snapshot.val().appointment;		    // 共乘時間
			var purpose = snapshot.val().purpose;			    // 共乘目的
            var note = snapshot.val().note;    		            // 備註
            phones = snapshot.val().phones;        	            // 手機
            email = snapshot.val().email;                       // 電子信箱

			var d = new Date(timestamp);
			time_text = getTimeStr(d);
		    
            var fb_image = "https://graph.facebook.com/"+fb_id+"/picture?type=normal";
            $('#fb_user_picture').attr("src", fb_image);
			$('#fb_user_name').text(fb_name);			
            $('#input_address_div').text(input_address);
            $('#destination_div').text(destination);
            $('#time_div').text(time_text);
            $('#purpose_div').text(purpose);
            $('#note_div').text(note);

            var facebook_id = window.localStorage.getItem("facebook_id");
            console.log("facebook_id("+facebook_id+") fb_id("+fb_id+")");
            if(fb_id == facebook_id) {
                
                $("#page1_info_form").hide();
                $("#self_div").show();
            }
		});
    }
    
    function contact_btn() {

        var message = "";
            message +=  '<div class="pop_message">';

        if(phones != "") {

            message +=  '<section class="section1">';
            message +=      "<ons-button class='button button--large' modifier='chevron' onclick='page1InfoClick(\"電話聯繫\")' style='background:#36d0c9; border-radius:0;'>";
            message +=          '<span style="font-size:18px">電話聯繫</span>';
            message +=      '</ons-button>';
            message +=  '</section>';

            message +=  '<section class="section1">';
            message +=      "<ons-button class='button button--large' modifier='chevron' onclick='page1InfoClick(\"簡訊聯繫\")' style='background:#36d0c9; border-radius:0;'>";
            message +=          '<span style="font-size:18px">簡訊聯繫</span>';
            message +=      '</ons-button>';
            message +=  '</section>';
        }

        if(email != "") {

            message +=  '<section class="section1">';
            message +=      "<ons-button class='button button--large' modifier='chevron' onclick='page1InfoClick(\"電子信箱聯繫\")' style='background:#36d0c9; border-radius:0;'>";
            message +=          '<span style="font-size:18px">電子信箱聯繫</span>';
            message +=      '</ons-button>';
            message +=  '</section>';
        }

        message +=  '<section class="section1">';
        message +=      '<ons-button class="button button--large" modifier="chevron" onclick="HoldOn.close()" style="background:#adadad; border-radius:0;">';
        message +=          '<span style="font-size:18px">取消</span>';
        message +=      '</ons-button>';
        message +=  '</section>';
        message +=  '</div>';

        options = {
            theme: "custom",
            message: message,
            textColor: "white"
        };
            
        HoldOn.open(options);
    }
    
    function fb_messenger_btn() {

        window.location = "https://m.me/" + fb_id;
    }
    
    function sms_btn() {

        window.location = "sms:" + phones;
    }

    function phone_click() {

        window.location = "tel:" + phones;
    }

    function email_btn() {

        var my_fb_name = window.localStorage.getItem("facebook_name");
        var msg = "";
        msg += "?subject=go2gether大車隊共乘";
        msg += "&body=Hi 我是 " + my_fb_name + " 我想跟你一起共乘去" + destination;
        msg += "%0D%0A%0D%0A%0D%0A%0D%0A";
        msg += "上車地點：" + input_address + "%0D%0A";
        msg += "下車地點：" + destination + "%0D%0A";
        msg += "出發時間：" + time_text + "%0D%0A";
        window.location.href = "mailto:" + email + msg;
    }

    function is_fb_player_enable() {
    
        var key = window.localStorage.getItem("facebook_id");
        players.child(key).once('value', function(snapshot) {
    
            if(snapshot.exists() == true) {
    
                var enable = snapshot.val().enable;
                var name = snapshot.val().name;
    
                if(enable != true) {
    
                    ons.createAlertDialog('alert-dialog.html').then(function(alertDialog) {
    
                        $('#page1AlertDialogText').html("帳號因違反使用者規範，詳細請洽客服");
                        $("#dialog_btn").attr("onclick","reload()");
                        alertDialog.show();
                    });
                }
            }
        });
    }

    function page7_click() {

        homeNavigator.pushPage("page7.html", {animation: 'slide'});
    }
    
    function page4_click() {

        tabbar.setActiveTab(3)
    }
    
    function closeDialog() {
        alertDialog.destroy();
    }

    function done_btn() {

        var key = window.localStorage.getItem("info_key");
        areas.child(key).once("value", function(snapshot) {

    		updateStatus(snapshot, "done");
            gotoPage1();
		});
    }

    function cancel_btn() {

        var key = window.localStorage.getItem("info_key");
        areas.child(key).once("value", function(snapshot) {

    		updateStatus(snapshot, "cancel");
            gotoPage1();
		});
    }
    
    function updateStatus(snapshot, status) {

        var area = {};
        area.address = snapshot.val().address ? snapshot.val().address : "";
        area.appointment = snapshot.val().appointment ? snapshot.val().appointment : "";
        area.city = snapshot.val().city ? snapshot.val().city : "";
        area.country = snapshot.val().country ? snapshot.val().country : "";
        area.destination = snapshot.val().destination ? snapshot.val().destination : "";
        area.expired_time = snapshot.val().expired_time ? snapshot.val().expired_time : "";
        area.fb_id = snapshot.val().fb_id ? snapshot.val().fb_id : "";
        area.fb_name = snapshot.val().fb_name ? snapshot.val().fb_name : "";
        area.email = snapshot.val().email ? snapshot.val().email : "";
        area.input_address = snapshot.val().input_address ? snapshot.val().input_address : "";
        area.latitude = snapshot.val().latitude ? snapshot.val().latitude : "";
        area.longitude = snapshot.val().longitude ? snapshot.val().longitude : "";
        area.name = snapshot.val().name ? snapshot.val().name : "";
        area.note = snapshot.val().note ? snapshot.val().note : "";
        area.phones = snapshot.val().phones ? snapshot.val().phones : "";
        area.postal_code = snapshot.val().postal_code ? snapshot.val().postal_code : "";
        area.priority = snapshot.val().priority ? snapshot.val().priority : "";
        area.purpose = snapshot.val().purpose ? snapshot.val().purpose : "";
        area.state = snapshot.val().state ? snapshot.val().state : "";
        area.timestamp = snapshot.val().timestamp ? snapshot.val().timestamp : "";
        area.status = status;

        if(status == "cancel") {
            
            var a = new Date(area.appointment);
            var year = a.getFullYear();
            var month = a.getMonth() + 1;
            var date = a.getDate();
            var hour = checkTime(a.getHours());
            var min = checkTime(a.getMinutes());
            var startDate = year+"/"+month+"/"+date;
            var startTime = hour+":"+min;
            console.log("startDate("+startDate+") startTime("+startTime+")");

            var to = area.email;
            var subject = "您的共乘需求已被取消 通知！- go2gether大車隊共乘";
            var body = area.fb_name + " 小姐/先生<br><br>";
            body += "感謝您使用go2gether大車隊共乘。<br>";
            body += "您的刊登需求因使用「取消」功能，網站首頁將不再顯示該筆刊登！<br>";
            body += "<br>";
            body += "已取消的刊登詳情如下：<br>";
            body += "上車地點："+area.input_address+"<br>";
            body += "下車地點："+area.destination+"<br />";
            body += "出發日期："+startDate+"<br>";
            body += "出發時間："+startTime+"<br>";
            
            if(area.note != "")     { body += "備註："+area.note+"<br>";        }
            if(area.phones != "")   { body += "手機號碼："+area.phones+"<br>";	}
            if(area.email != "")    { body += "電子信箱："+area.email+"<br>";	}
            
            body += "<br>";
            body += "<font color='red'>為了提供您更優質的共乘體驗，希望您對於此次共乘網站使用的經驗，</font><br />";
            body += "<font color='red'>有任何建議或意見提供，請分享給我們！</font><br />";
            body += "<font color='red'>go2gether大車隊共乘 使用體驗分享：</font><br />";
            body += "<a href='https://goo.gl/forms/DWJF2ekv9BdWvy663'>https://goo.gl/forms/DWJF2ekv9BdWvy663</a><br />";
            body += "<br />";
            body += "<br />";
            body += "如果您有任何疑問，請隨時聯繫我們。<br />";
            body += "感謝您使用go2gether大車隊共乘<br />";
            body += "活動網站：<a href='https://goo.gl/gje0G6'>https://goo.gl/gje0G6</a><br />";
            body += "官方粉絲團：<a href='https://goo.gl/cVIwMp'>https://goo.gl/cVIwMp</a><br />";
            body += "<br />";

            $.post("https://17-vr-live.wonliao.com/go2gether/www/backend/send_mail.php", 
                { 
                    "to": to,
                    "subject": subject,
                    "body": body
                }
            );
        }

		var area_updates = {};
		area_updates['/areas/' + snapshot.key] = area;
		firebase.database().ref().update(area_updates);
        
        // 清除 makers
        firebaseRef.child(snapshot.key).remove();
    }    
    
    function checkTime(i) {

        if (i<10) { i = "0" + i; }
        return i
    }
    
    function page1_info_back() {

        showFloatIcon();
        homeNavigator.popPage();
    }
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-84401162-1', 'auto');
  ga('send', 'pageview', '共乘條件頁');
</script>